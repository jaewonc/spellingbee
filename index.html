<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Bee Practice</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url('background.jpg') no-repeat center center;
            background-size: cover;
            filter: blur(2px);
            z-index: -1;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 40px 100px rgba(0,0,0,0.7);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .content {
            padding: 40px;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #718096;
            margin-top: 5px;
        }
        
        .word-display {
            background: #f7fafc;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #4a5568;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 20px 0;
            transition: all 0.3s;
            background: white;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input[type="text"]:disabled {
            background: #f7fafc;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        input[type="number"] {
            padding: 10px 12px;
            font-size: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
            width: 80px;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            flex: 1;
            padding: 14px 20px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }
        
        .btn-secondary {
            background: #cbd5e0;
            color: #2d3748;
        }
        
        .btn-secondary:hover {
            background: #a0aec0;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #cbd5e0;
        }
        
        button:disabled:hover {
            transform: none;
            box-shadow: none;
            background: #cbd5e0;
        }
        
        .feedback {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .feedback-correct {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .feedback-incorrect {
            background: #fed7d7;
            color: #742a2a;
        }
        
        .feedback-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .results-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            background: #fff5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #fc8181;
        }
        
        .result-item strong {
            color: #742a2a;
            font-size: 18px;
        }
        
        .result-item .definition {
            color: #4a5568;
            margin: 5px 0;
        }
        
        .result-item .user-answer {
            color: #e53e3e;
            font-style: italic;
        }
        
        .perfect {
            background: #c6f6d5;
            color: #22543d;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden { display: none; }
        
        .option-group {
            margin: 20px 0;
            text-align: left;
        }
        
        .option-group h3 {
            margin-bottom: 12px;
            color: #2d3748;
            font-size: 16px;
        }
        
        .radio-container {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            color: #667eea;
        }
        
        .option-group label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin: 4px 0;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 16px;
            color: #2d3748;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .option-group label:hover {
            background: #f7fafc;
        }
        
        .option-group input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e0;
            border-radius: 50%;
            margin-right: 12px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .option-group input[type="radio"]:checked {
            border-color: #667eea;
            background: #667eea;
        }
        
        .option-group input[type="radio"]:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .option-group input[type="radio"]:hover {
            border-color: #667eea;
        }
        
        select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 15px 0;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23667eea' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        select:hover {
            border-color: #cbd5e0;
        }
        
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .history-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .graph {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .line-chart {
            position: relative;
            height: 180px;
            margin-top: 20px;
        }
        
        .chart-svg {
            width: 100%;
            height: 150px;
        }
        
        .chart-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 11px;
            color: #718096;
        }
        
        .footer {
            text-align: center;
            color: #718096;
            font-size: 14px;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üêù Spelling Bee Practice</h1>
            <p>Master your spelling skills</p>
        </div>
        
        <div class="content">
            <div id="setup">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading word list...</p>
                </div>
                <div id="loadStatus"></div>
            </div>

            <div id="practice" class="hidden">
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" id="totalStat">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="correctStat">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="wrongStat">0</div>
                        <div class="stat-label">Wrong</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="accuracyStat">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
                
                <div class="word-display" id="wordDisplay">
                    <em>Listen to the word and definition...</em>
                </div>
                
                <input type="text" id="userInput" placeholder="Type the spelling here" 
                       onkeypress="handleEnter(event)" autocomplete="off" spellcheck="false">
                
                <div class="btn-group">
                    <button class="btn-primary" id="submitBtn" onclick="checkAnswer()">Submit Answer</button>
                    <button class="btn-success" id="repeatBtn" onclick="pronounceWord()">Repeat Word</button>
                    <button class="btn-secondary" onclick="stopPractice()">Stop Practice</button>
                </div>
            </div>

            <div id="results" class="hidden">
                <h2 style="margin-bottom: 20px;">üìä Practice Results</h2>
                
                <div class="stats-bar">
                    <div class="stat-card">
                        <div class="stat-value" id="finalTotal">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="finalCorrect">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="finalWrong">0</div>
                        <div class="stat-label">Wrong</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="finalAccuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 10px 0;">Review Mistakes</h3>
                <div id="wrongAnswers" class="results-list"></div>
                
                <div id="historyStats"></div>
                
                <button class="btn-primary" onclick="restart()" style="width: 100%; margin-top: 20px;">
                    Start New Practice
                </button>
                <button class="btn-secondary" onclick="backToSelection()" style="width: 100%; margin-top: 10px;">
                    Change Word List
                </button>
            </div>
            
            <div class="footer">
                ¬© 2025 Jaewon Choi (<a href="mailto:cmdrkeen@gmail.com" style="color: #667eea; text-decoration: none;">cmdrkeen@gmail.com</a>)
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let currentWord = null;
        let correct = 0;
        let total = 0;
        let wrongList = [];
        let selectionMode = 'random';
        let currentIndex = 0;
        let wordlistFiles = [];
        let sessionHistory = [];
        let currentWordlist = '';
        let voiceSpeed = 0.7;
        let nextWordTimeout = null;
        let isSpeaking = false;

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('spellingBeeHistory');
                if (saved) {
                    sessionHistory = JSON.parse(saved);
                }
            } catch (e) {
                sessionHistory = [];
            }
        }

        function saveSession() {
            const session = {
                date: new Date().toISOString(),
                wordlist: currentWordlist,
                total: total,
                correct: correct,
                wrong: total - correct,
                accuracy: total > 0 ? Math.round((correct / total) * 100) : 0
            };
            sessionHistory.push(session);
            try {
                localStorage.setItem('spellingBeeHistory', JSON.stringify(sessionHistory));
            } catch (e) {
                console.warn('Failed to save history:', e);
            }
        }

        window.onload = function() {
            loadHistory();
            
            // Generate possible wordlist files for years 2020-2030
            const currentYear = new Date().getFullYear();
            const possibleFiles = [];
            for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                possibleFiles.push(`wordlist-${year}.csv`);
            }
            
            let foundFiles = [];
            let checkPromises = possibleFiles.map(file => 
                fetch(`wordlists/${file}`, { method: 'HEAD' })
                    .then(response => response.ok ? file : null)
                    .catch(() => null)
            );
            
            Promise.all(checkPromises).then(results => {
                foundFiles = results.filter(f => f !== null);
                
                if (foundFiles.length === 0) {
                    document.getElementById('setup').innerHTML = 
                        `<div style="text-align: center; color: #e53e3e;">
                            <p style="font-size: 18px; margin-bottom: 10px;">‚ùå No wordlist files found</p>
                            <p style="color: #718096;">Place CSV files in the 'wordlists' folder.</p>
                        </div>`;
                    return;
                }
                
                wordlistFiles = foundFiles;
                showFileSelection();
            });
        };

        function showFileSelection() {
            const options = wordlistFiles.map(file => 
                `<option value="${file}">${file.replace('.csv', '').replace('wordlist-', 'Year ')}</option>`
            ).join('');
            
            document.getElementById('setup').innerHTML = 
                `<div style="text-align: center;">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">Select Word List</h3>
                    <select id="wordlistSelect">${options}</select>
                    <button class="btn-primary" onclick="loadWordlist()" style="width: 100%;">
                        Load Word List
                    </button>
                </div>`;
        }

        function loadWordlist() {
            const selectedFile = document.getElementById('wordlistSelect').value;
            currentWordlist = selectedFile.replace('.csv', '').replace('wordlist-', '');
            document.getElementById('setup').innerHTML = 
                `<div class="loading">
                    <div class="spinner"></div>
                    <p>Loading word list...</p>
                </div>`;
            
            fetch(`wordlists/${selectedFile}`)
                .then(response => {
                    if (!response.ok) throw new Error('Could not load wordlist');
                    return response.text();
                })
                .then(data => {
                    const lines = data.trim().split('\n');
                    lines.shift();
                    
                    words = lines.map(line => {
                        const parts = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            if (char === '"' && line[i + 1] === '"') {
                                current += '"';
                                i++;
                            } else if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                parts.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        parts.push(current.trim());
                        
                        if (parts.length < 2 || !parts[1]) return null;
                        
                        return {
                            word: parts[1].trim(),
                            partOfSpeech: parts[2]?.trim() || '',
                            definition: parts[3]?.trim() || 'No definition provided',
                            alternative: parts[4]?.replace(/"/g, '').trim() || ''
                        };
                    }).filter(w => w);
                    
                    if (words.length === 0) throw new Error('No valid words found');
                    
                    showPracticeOptions();
                })
                .catch(error => {
                    document.getElementById('setup').innerHTML = 
                        `<div style="text-align: center; color: #e53e3e;">
                            <p style="font-size: 18px; margin-bottom: 10px;">‚ùå ${escapeHtml(error.message)}</p>
                            <button class="btn-secondary" onclick="showFileSelection()" style="width: 100%; margin-top: 10px;">
                                Back to Selection
                            </button>
                        </div>`;
                });
        }

        function showPracticeOptions() {
            document.getElementById('setup').innerHTML = 
                `<div style="text-align: center;">
                    <p style="font-size: 18px; color: #48bb78; margin-bottom: 20px;">
                        ‚úì ${words.length} words loaded successfully
                    </p>
                    <div class="option-group">
                        <h3>Word Selection Mode:</h3>
                        <div class="radio-container">
                            <label>
                                <input type="radio" name="mode" value="random" checked onchange="selectionMode='random'">
                                <span>Random order</span>
                            </label>
                            <label>
                                <input type="radio" name="mode" value="ordinal" onchange="selectionMode='ordinal'">
                                <span>Sequential order (start at word #<input type="number" id="startNum" min="1" max="${words.length}" value="1" onclick="event.stopPropagation(); this.parentElement.parentElement.querySelector('input[type=radio]').checked=true; selectionMode='ordinal';">)</span>
                            </label>
                        </div>
                    </div>
                    <div class="option-group">
                        <h3>Voice Speed:</h3>
                        <div class="slider-container">
                            <input type="range" id="voiceSpeed" min="0.3" max="1.0" step="0.1" value="${voiceSpeed}" oninput="voiceSpeed=parseFloat(this.value); document.getElementById('speedValue').textContent=this.value">
                            <span class="slider-value" id="speedValue">${voiceSpeed}</span>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="startPractice()" style="width: 100%;">
                        Start Practice Session
                    </button>
                </div>`;
        }

        function startPractice() {
            if (selectionMode === 'ordinal') {
                const startNum = parseInt(document.getElementById('startNum').value) || 1;
                currentIndex = Math.max(0, Math.min(startNum - 1, words.length - 1));
            }
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('practice').classList.remove('hidden');
            updateStats();
            nextWord();
        }

        function nextWord() {
            if (nextWordTimeout) clearTimeout(nextWordTimeout);
            isSpeaking = false;
            speechSynthesis.cancel();
            
            if (words.length === 0) {
                stopPractice();
                return;
            }
            
            if (selectionMode === 'ordinal') {
                if (currentIndex >= words.length) {
                    stopPractice();
                    return;
                }
                currentWord = words[currentIndex];
                currentIndex++;
            } else {
                currentWord = words[Math.floor(Math.random() * words.length)];
            }
            
            const inputField = document.getElementById('userInput');
            inputField.value = '';
            inputField.disabled = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('repeatBtn').disabled = false;
            document.getElementById('wordDisplay').innerHTML = '<em>Listen to the word and definition...</em>';
            inputField.focus();
            pronounceWord();
        }

        function pronounceWord() {
            if (!window.speechSynthesis || !currentWord || isSpeaking) return;
            speechSynthesis.cancel();
            isSpeaking = true;
            document.getElementById('repeatBtn').disabled = true;
            
            const utterance = new SpeechSynthesisUtterance(currentWord.word);
            utterance.rate = voiceSpeed;
            
            utterance.onend = () => {
                const defUtterance = new SpeechSynthesisUtterance(currentWord.definition);
                defUtterance.rate = voiceSpeed;
                
                defUtterance.onend = () => {
                    const finalUtterance = new SpeechSynthesisUtterance(currentWord.word);
                    finalUtterance.rate = voiceSpeed;
                    finalUtterance.onend = () => { 
                        isSpeaking = false;
                        document.getElementById('repeatBtn').disabled = false;
                    };
                    speechSynthesis.speak(finalUtterance);
                };
                
                speechSynthesis.speak(defUtterance);
            };
            
            speechSynthesis.speak(utterance);
        }

        function updateStats() {
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            document.getElementById('totalStat').textContent = total;
            document.getElementById('correctStat').textContent = correct;
            document.getElementById('wrongStat').textContent = total - correct;
            document.getElementById('accuracyStat').textContent = accuracy + '%';
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('userInput').value.trim().replace(/\s+/g, ' ').toLowerCase();
            if (!userAnswer) return;
            
            if (nextWordTimeout) clearTimeout(nextWordTimeout);
            isSpeaking = false;
            speechSynthesis.cancel();
            
            document.getElementById('userInput').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('repeatBtn').disabled = true;
            
            const correctAnswer = currentWord.word.toLowerCase();
            const alternativeAnswer = currentWord.alternative ? currentWord.alternative.toLowerCase() : '';
            total++;
            
            if (userAnswer === correctAnswer || (alternativeAnswer && userAnswer === alternativeAnswer)) {
                correct++;
                document.getElementById('wordDisplay').innerHTML = 
                    `<div style="font-size: 48px;">üêπ</div>
                     <div style="color: #48bb78; font-size: 18px; font-weight: bold; margin-top: 10px;">‚úì Correct!</div>`;
            } else {
                wrongList.push({
                    word: currentWord.word,
                    definition: currentWord.definition,
                    userAnswer: userAnswer,
                    alternative: currentWord.alternative
                });
                const altText = currentWord.alternative ? ` or ${escapeHtml(currentWord.alternative)}` : '';
                document.getElementById('wordDisplay').innerHTML = 
                    `<div style="font-size: 48px;">üêä</div>
                     <div style="color: #e53e3e; font-size: 18px; font-weight: bold; margin-top: 10px;">‚úó Wrong!</div>
                     <div style="color: #2d3748; font-size: 18px; margin-top: 10px;">Correct: <strong>${escapeHtml(currentWord.word)}${altText}</strong></div>`;
            }
            
            updateStats();
            nextWordTimeout = setTimeout(nextWord, 3000);
        }

        function handleEnter(event) {
            if (event.key === 'Enter') checkAnswer();
        }

        function stopPractice() {
            if (nextWordTimeout) clearTimeout(nextWordTimeout);
            isSpeaking = false;
            speechSynthesis.cancel();
            saveSession();
            
            document.getElementById('practice').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
            
            const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
            document.getElementById('finalTotal').textContent = total;
            document.getElementById('finalCorrect').textContent = correct;
            document.getElementById('finalWrong').textContent = total - correct;
            document.getElementById('finalAccuracy').textContent = accuracy + '%';
            
            if (wrongList.length > 0) {
                document.getElementById('wrongAnswers').innerHTML = wrongList.map(item => {
                    const altText = item.alternative ? ` or ${escapeHtml(item.alternative)}` : '';
                    return `<div class="result-item">
                        <strong>${escapeHtml(item.word)}${altText}</strong>
                        <div class="definition">${escapeHtml(item.definition)}</div>
                        <div class="user-answer">Your answer: ${escapeHtml(item.userAnswer) || '(no answer)'}</div>
                    </div>`;
                }).join('');
            } else {
                document.getElementById('wrongAnswers').innerHTML = 
                    '<div class="perfect">üéâ Perfect score! No mistakes!</div>';
            }
            
            showHistoryStats();
        }

        function showHistoryStats() {
            const historyDiv = document.getElementById('historyStats');
            if (sessionHistory.length === 0) {
                historyDiv.innerHTML = '';
                return;
            }
            
            const totalSessions = sessionHistory.length;
            const totalWords = sessionHistory.reduce((sum, s) => sum + s.total, 0);
            const totalCorrect = sessionHistory.reduce((sum, s) => sum + s.correct, 0);
            const avgAccuracy = totalWords > 0 ? Math.round((totalCorrect / totalWords) * 100) : 0;
            
            const last10 = sessionHistory.slice(-10);
            const width = 500;
            const height = 150;
            const padding = 20;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;
            
            // Find max word count for scaling
            const maxWords = Math.max(...last10.map(s => s.total), 1);
            
            // Create points for accuracy line
            const accuracyPoints = last10.length === 1 
                ? `${padding},${height - padding - (last10[0].accuracy / 100) * chartHeight} ${width - padding},${height - padding - (last10[0].accuracy / 100) * chartHeight}`
                : last10.map((s, i) => {
                    const x = padding + (i / (last10.length - 1)) * chartWidth;
                    const y = height - padding - (s.accuracy / 100) * chartHeight;
                    return `${x},${y}`;
                }).join(' ');
            
            // Create points for word count line
            const wordPoints = last10.length === 1
                ? `${padding},${height - padding - (last10[0].total / maxWords) * chartHeight} ${width - padding},${height - padding - (last10[0].total / maxWords) * chartHeight}`
                : last10.map((s, i) => {
                    const x = padding + (i / (last10.length - 1)) * chartWidth;
                    const y = height - padding - (s.total / maxWords) * chartHeight;
                    return `${x},${y}`;
                }).join(' ');
            
            // Create circles and labels for data points
            const circles = last10.map((s, i) => {
                const x = last10.length === 1 ? width / 2 : padding + (i / (last10.length - 1)) * chartWidth;
                const yAcc = height - padding - (s.accuracy / 100) * chartHeight;
                const yWords = height - padding - (s.total / maxWords) * chartHeight;
                return `<circle cx="${x}" cy="${yAcc}" r="4" fill="#667eea"/>
                        <text x="${x}" y="${yAcc - 10}" text-anchor="middle" font-size="12" fill="#667eea">${s.accuracy}%</text>
                        <circle cx="${x}" cy="${yWords}" r="4" fill="#48bb78"/>
                        <text x="${x}" y="${yWords - 10}" text-anchor="middle" font-size="12" fill="#48bb78">${s.total}</text>`;
            }).join('');
            
            // Create labels
            const labels = last10.map(s => {
                const date = new Date(s.date);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                return `<span>${dateStr}<br>${timeStr}</span>`;
            }).join('');
            
            historyDiv.innerHTML = `
                <div class="history-section">
                    <h3 style="margin-bottom: 15px;">üìà All-Time Statistics</h3>
                    <div class="history-stats">
                        <div class="stat-card">
                            <div class="stat-value">${totalSessions}</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalWords}</div>
                            <div class="stat-label">Total Words</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${avgAccuracy}%</div>
                            <div class="stat-label">Avg Accuracy</div>
                        </div>
                    </div>
                    <div class="graph">
                        <h4 style="margin-bottom: 10px; color: #2d3748;">Recent Sessions (Last ${last10.length})</h4>
                        <div style="margin-bottom: 10px;">
                            <span style="color: #667eea; margin-right: 15px;">‚óè Accuracy %</span>
                            <span style="color: #48bb78;">‚óè Word Count</span>
                        </div>
                        <div class="line-chart">
                            <svg class="chart-svg" viewBox="0 0 ${width} ${height}">
                                <line x1="${padding}" y1="${height - padding}" x2="${width - padding}" y2="${height - padding}" stroke="#e2e8f0" stroke-width="2"/>
                                <line x1="${padding}" y1="${padding}" x2="${padding}" y2="${height - padding}" stroke="#e2e8f0" stroke-width="2"/>
                                <polyline points="${accuracyPoints}" fill="none" stroke="#667eea" stroke-width="3"/>
                                <polyline points="${wordPoints}" fill="none" stroke="#48bb78" stroke-width="3"/>
                                ${circles}
                            </svg>
                            <div class="chart-labels">${labels}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function restart() {
            correct = 0;
            total = 0;
            wrongList = [];
            currentIndex = 0;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
            showPracticeOptions();
        }

        function backToSelection() {
            words = [];
            correct = 0;
            total = 0;
            wrongList = [];
            selectionMode = 'random';
            currentIndex = 0;
            document.getElementById('results').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
            showFileSelection();
        }
    </script>
</body>
</html>
